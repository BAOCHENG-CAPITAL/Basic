# 投资组合分析

## 单变量资产组合排序分析流程

### 单变量资产组合排序分析流程

单变量资产组合排序分析（univariate portfolio analysis）是指只基于某单个变量进行资产组合构建分析的方法。以X作为分组变量（例如：企业市值、企业市盈率等），参数k,m,n的单变量z组资产组合排序分析一共分为四个步骤（k代表构建指标的信息区间、m代表等待建仓的时间、n代表持有资产组合的时间）。 

第一，计算任意t时刻分组指标X的分位数数值。计算t时刻所有股票在[t-k,t]时间段内的指标X，并计算所有股票X特征的Z分位点数。其中k是指使用过去多久的指标X作为单变量资产分组指标，一般会选取k=0，也就是使用当天收盘的指标X作为单变量资产分组指标，如果选取k=1，也就是使用过去1期平均指标X作为单变量资产分组指标。对于某些指标计算依赖长时间窗口的变量或者是变化特别敏感的变量，会选取过去一段时间k=1,6,12来计算该指标。

第二，根据分为数值和等待期建立不同的资产组合。根据t时刻计算并根据每只股票X特征所属的分位数数值进行分组，在等待建仓的时间m到来后（一般m为0，也就是假设在t时刻立即建仓），确定每组分位数的资产个数和权重构建投资组合。

第三，持有资产并计算各个资产组合持有期的投资收益。有了资产组合后，就可以计算资产组合在每一期的收益表现，分析中关注持有期n满后，[t+m,t+m+n]时间段（建仓到卖出）的不同投资组合实现的收益率的差异情况。

第四，循环前三步，获得全样本时刻不同资产收益率的时间序列并进行统计检验。但是这只是一期的数据情况，我们是无法从一期的样本数据中得到任何可靠的统计推断结论的。因此接下来需要把上述流程按照全部样本时间区间进行循环，计算样本全部时间T的不同投资组合实现收益率的时间序列。对投资组合的收益率进行统计检验，根据其收益率的时间序列是否显著异于0，就能够检验在全部样本中，X这个股票特征能否用来预测未来股票收益率了。

### 单变量资产组合排序分析实际案例分析

## 多变量资产组合排序检验方法介绍（以双变量资产组合排序为例）

### 双变量资产组合排序

前面介绍的单变量资产组合排序分析是分析变量与未来收益率之间的关系最简单且常用的方法，但是该方法的局限性在于，它只能分析某一个变量的单独影响，不能把其他变量的影响也考虑进来。双变量资产组合排序（bivariate portfolio analysis）的方法能够同时考虑X_1和X_2对另外一个结果变量Y（未来收益率）的影响。双变量资产组合排序的方法分为两种：独立（independent）双重排序和非独立（dependent）双重排序。

### 独立双重排序方法介绍

独立双变量资产组合排序的流程与单变量资产组合排序基本类似，只是在前面构建资产组合的时候会有不同。以X_1和X_2作为分组变量（例如：企业市值、企业市盈率等），双变量Z组资产组合排序分析为例，其分析的四个步骤只有前两个步骤与前面有些差别，后面的步骤都与前面一样。

第一，计算在任意t时刻分组指标X1和X2的分位数数值。t时刻计算该时刻所有股票在[t-k,t]时间段内的指标X1和X2，并在全部样本中独立计算所有股票X1和X2特征的Z分位数点。

第二，根据分位数值和等待期建立不同的资产组合。根据t时刻计算并根据每只股票X特征所属的分位数数值进行分组，在等待建仓的时间m到来后（一般m为0，也就是假设在t时刻立即建仓），确定每组分位数的资产个数和权重构建投资组合。在单变量资产组合排序分析中，最终形成的资产组合数量一般与Z是相同的。例如，单变量10组资产组合排序分析，分析对象就是这10组资产组合的收益率差异情况（通常会再额外加一组高减低的对冲资产组合）。而在双变量Z组资产组合排序中，最终形成的资产组合数量一般有ZxZ个。例如，双变量10组资产组合排序分析，分析对象就是这100组资产组合的收益率差异情况。

独立双重排序方法可以很好地控制某个因子给投资组合带来的影响，目前广泛用于各种因子投资组合的构建中，如经典的FF3中的SMB因子和HML因子就是依照独立双重排序的方法构建出来的。

### 非独立双重排序方法介绍

非独立双变量资产组合排序的流程与单变量资产组合排序基本类似，只是在前面构建资产组合的时候会稍有不同。在独立双变量资产组合排序中，会在全部样本中独立计算X1和X2特征的Z分位数点。而在非独立双变量资产组合排序中，是有严格顺序要求的，需要先计算X1的特征的Z分位数点，然后再X1的每个分位数组内计算出组内的X2特征的Z分位数点。非独立双变量资产组合排序方法能够很好地回答以下问题：当控制组特征X1后，X2对于Y的影响是否与X1有关这一问题。

# 因子投资

## 因子投资与smart beta产品

## 因子投资产品举例

## 因子投资产品的优势

## 因子投资的挑战

# 中国因子模型（CH4）

因子模型是整个资产定价的基石，因子描述着所有资产背后共同面临的系统性风险，而因子的收益率就是承担系统性风险从而获得的风险溢价（或风险补偿）。不同的资产收益率不同，是因为不同资产本身在因子上的风险暴露程度不同导致的。为了更形象地理解因子，我们参照全球最大的资产管理公司贝莱德主管因子投资策略团队的Andrew Ang的比喻：因子之于资产就如同营养成分之于食品，因子是资产收益和风险的驱动（driver）。许多食品都包含一种以上的大类营养产品，如水、碳水化合物、蛋白质、脂肪和纤维等，进食是为了获得食品所包含的营养成分，类似地，重要的是因子而非资产本身。正确的因子投资是透过资产类别标签去理解其背后的因子构成。

不同的因子模型定义不同的系统性风险。中国股市长期存在IPO(initial public offering，首次公开发行)发行审核严格、进度较慢的问题，中国股票市场中市值最小的30%股票会隐含部分被其他想要上市的公司借壳上市的价值，这部分股票的“壳价值”会对传统资产定价模型产生影响，因此应该删除。中国股票市场的价值指标采用市盈率的倒数来衡量EP（earnings-to-price）要显著好于用账面市值比bm（book-to-market）；针对中国股票市场由于散户非理性交易导致的反转和换手率异象，提出了加入换手率因子之后的改进版CH4（中国四因素模型）因子。

## 数据清洗与基础变量准备

构建四因子需要的基础变量有以下几个。

### 复权收益率

复权收益率(adj_ret)是经过分红、拆股、配股等时间调整好的收益率

### 企业市值

企业市值（ME）是企业的A股总市值。

### 企业价值

企业价值（EP）用市盈率的倒数（earnings-price ratio）来衡量。

### 异常换手率

企业的异常换手率（abnormal turnover,AT）用企业过去20个交易日的日度换手率均值除以过去250个交易日的日度换手率均值来衡量。

## 因子模型的构建

具体的CH4表达公式包括4个因子：市场因子（MKT）、规模因子（SMB）、价值因子（value-minus-growth,VMG）、流动性因子（pressimistic-minus-optimistic,PMO）
$$
E[R_i]-R_f=\beta_i^{MKT}（MKT_i）+\beta_i^{SMB}（SMB_i）+\beta_i^{VMG}（VMG_i）+\beta_i^{PMO}（PMO_i）+\epsilon_i
$$

### 市场因子

T期的市场因子（MKT）的收益率，等于全市场股票按照T-1期A股总市值（ME）加权形成投资组合的收益率减去一年期定期存款利率。

### 规模因子

规模因子（SMB）需要进行中性化处理。在三因子和四因子的版本中，中性化的方式稍有不同，不同之处在于三因子版本的规模因子是由2x3的规模x价值因子，基于独立双变量资产组合排序构造而成。
$$
SMB=1/3(S/V+S/M+S/G)-1/3(B/V+B/M+B/G)
$$
在T-1期构建资产组合的逻辑为：

1. 按照A股总市值（ME）指标的中位数将样本分为两组：大股票价值（B）和小股票价值（S）。
2. 按照企业价值（EP）指标，将样本分为3组：最大为前30%为高估值股票价值（V）、中间40%为中估值股票价值（M）和最小的后30%为低估值股票价值（G）。将两个指标结合起来就能把所有股票划分形成6组按照市值和价值组合的资产组合：S/V、S/M、S/G、B/V、B/M和B/G。每个资产组合依然使用股票的A股总市值进行加权。四因子的版本下逻辑与前面类似，只是把中性化指标进行了替换，即将２X３规模X价值因子替换成了2X3规模X异常换手率因子。

### 价值因子

规模中性化处理后的价值因子（VMG）由2X2的规模X价值因子，基于独立双变量资产组合排序构造而成，具体计算见方程。
$$
VMG=1/2(S/V+B/V)-1/2(S/G+B/G)
$$

### 换手率因子

规模中性化处理过后的换手率因子（PMO）与价值因子的构建非常类似。由2X2的规模X换手率因子，基于独立双变量资产组合排序构造而成，具体计算见方程
$$
PMO=1/2(S/P+B/P)-1/2(S/O+B/O)
$$
在T-1期构建资产组合的逻辑为：

1. 按照A股总市值（ME）指标的中位数将样本分为两组：大股票价值（B）和小股票价值（S）。
2. 按照企业的异常换手率（AT）指标，将样本分为3组：最大的前30%为高异常换手率股票价值（O）、中间40%为中换手率股票价值（M）和最小的后30%为低换手率股票价值（P）。将两个指标结合起来就能把所有股票划分形成6组按照市值和价值组合的资产组合：S/O S/M S/P B/O B/M和B/P。每个资产组合依然使用股票的A股总市值（ME）进行加权。

## CH4因子的描述性统计

# 异象性因子的检验

## 异象性因子介绍

异象性因子是指根据某个股票特征，用投资组合排序的方法构建出一个资产组合，该资产组合的收益率如果不能被上述因子模型解释，那么就称该特征形成的投资组合为异象性因子，这个特征称为异象性特征。研究异象性因子的意义在于，如果能够找到市场上的某种异象性因子，那么意味着你能够构建获得一个拥有超额收益且不能被风险因子模型所解释的投资组合。这一方面是对市场有效性理论的挑战；另一方面现实世界的投资人而言，是非常有实际价值的。

表2-2

## 异象性因子的时序回归统计检验

### 时序回归统计检验介绍

时序回归统计检验是异象性因子最常用的检验方法。假设Rt为异象性特征形成的投资组合收益率的时间序列，其中t代表收益率的时序t(1,2,...,T)，lambdat代表t时刻的K维的因子收益率向量（例如在前面介绍的CH4因子模型中有4个因子，即K=4）。在进行异象性检验时，需要用lambdat作为解释变量，回归方程左边Rt为被解释变量，进行时间序列回归检验，如方程所示：
$$
R_t=\widehat{a}+\widehat{\beta'}\lambda_t+\widehat{\epsilon_t}
$$
在检验某投资组合是否异象时，统计模型的原假设是异象收益率不存在因子模型无法解释的部分，即横截项alpha=0，如果异象性因子的收益率不能被因子收益率的线性组合所揭示，那么横街项的估计系数alpha将在统计上显著不为0.方程中beta是K维因子收益率的风险暴露的估计，它的经济学含义在于，方程左边形成的投资组合在不同因子上的风险暴露情况。epsilon是随机扰动项。

### Newey-West调整

正确的统计推断依赖于科学的统计量计算。需要特别指出的是，OLS（ordinary least square最小二乘）估计中需要假设随机扰动项是白噪声，否则当随机扰动项存在自相关或者异方差问题时，OLS估计获得的标准误就是有偏的，这会导致计算的t统计量也会有偏，无法获得正确的统计推断理论。在实际的因子收益率数据中，OLS的假设往往不会被满足，此时需要对统计量进行修正。Newey-West调整就是针对以上问题给出的一个标准误统计量调整方法，这个方法由Newey和West两位作者于1987年提出，是目前实证资产定价领域中最常用的调整方法，谷歌学术引用量超2万。

```python
statsmodels.api.OLS(y,X).fit(cov_type='HAC',cov_kwds{'maxlags':4})
```

参数解释：
y：被解释变量

X：解释变量和控制变量，如果数据中没有常数项，需要手动添加。

cov_type：使用参数'HAC'来获得Newey-West调整后的标准误统计量。

cov_kwds：使用字典{'maxlags':4}来指定滞后的期数，可以根据Newey和West提供的公式L=[4x(T/100)^(2/9)]计算得到。

### 时序回归统计检验举例

具体地采用前面介绍的CH4因子模型作为基准风险模型，对根据小市值减去大市值（L-H）的资产组合进行时间序列异象性检验，将估计方程改写成方程：
$$
R_t=\widehat{\alpha}+\widehat{\beta^{MKT}}(MKT_t)+\widehat{\beta^{SMB}}(SMB_t)+\widehat{\beta^{VMG}}(VMG_t)+\widehat{\beta^{PMO}}(PMO_t)+\widehat{\epsilon_t}
$$

## 股票特征与未来收益率的检验：Fama-MacBeth截面回归

### Fama-MacBeth截面回归流程介绍

在前面的统计检验设计中，有一个缺点在于检验某变量对于未来收益率影响时，不能很好地控制其他潜在变量的影响。为了克服以上缺陷，Fama-MacBeth截面回归分析是一个很好的统计工具。

沿用前面的设定，假设解释变量用Y（例如未来一个月的收益率）表示，核心解释变量用X（例如企业流通市值）表示，需要控制的协变量为X1，X2...（例如企业价值和企业换手率）。Fama-MacBeth截面回归分析分为两步。第一，对每一个时间t(t=1,2,..,T)，基于横截面样本进行回归分析，记录下每一期横截面回归的回归系数、样本量、调整后R2。第二，Fama-MacBeth最后的回归系数、样本量、调整后R2为T期取平均，系统的统计量为对T期的以上回归系数的时间序列进行统计检验，检验各项回归系数的时间序列是否显著异于零。需要注意的是，这里的统计检验量也需要使用前面介绍的Newey-West调整。

### Fama-MacBeth截面回归举例说明

依然沿用前面的案例，需要研究中国股票市场2000年1月到2021年6月（共计258个月）样本中，控制企业价值和换手率的条件下企业总市值变量是否能够用于预测未来一个月的收益率。总体的回归设定如方程所示:
$$
R_{i,t+1}=\widehat{\alpha}+\widehat{\beta}^{ME}(X\_ME_{i,t})+\widehat{\beta}^{EP}(X\_EP_{i,t})+\widehat{\beta}^{AT}(X\_AT_{i,t})+\widehat{\epsilon_{i,t}}
$$
其中，左边是被解释变量，代表第i值股票第t+1个月的月度收益率。X_ME是核心解释变量，代表第i只股票第t个月月底的A股总市值；X_EP是控制变量，代表第i只股票第t个月月底的市盈率倒数；X_AT是控制变量，代表第i只股票第t个月月底异常换手率；epsilon是随机扰动项。在Fama-MacBeth截面回归中，最需要关注的系数是betaME大小和显著性水平，这个系数代表企业市值的变动会给企业未来一个月收益率带来多大影响。

需要注意的是，进行以上回归时，为了剔除异常值对回归系数的影响，一般会对解释变量进行缩尾处理，而对于被解释变量一般不进行缩微处理。此外，由于股票市场横截面的市值变量分布会呈现出长尾分布，这种非标准正态分布也可能对估计系数造成较大影响，一般会对变量取对数处理。

此外，在对方程进行估计时，一般会采用不同的方程设定，给出多个设定下模型估计的结果。例如：

1. 单独把企业总市值回归在未来一个月的收益率上，不添加任何控制变量
2. 把企业总市值回归在未来一个月的收益率上，只添加市盈率倒数作为控制变量
3. 把企业总市值回归在未来一个月的收益率上，只添加异常换手率作为控制变量
4. 按照模型设定，把企业总市值回归在未来一个月的收益率上，同时添加市盈率倒数和异常换手率作为控制变量。

### 使用Fama-MacBeth截面回归分析的具体流程

1. 对t=1到t=T，每一个月横截面样本用方程设定进行估计，共计估计258次，记录下每一期横截面回归的回归系数，样本量，调整后R2。
2. Fama-MacBeth最后的回归系数、样本量、调整后R2为T期取平均，系统的统计量为对T期258期的以上回归系数的时间序列进行统计检验，检验各项回归系数的时间序列是否显著异于0

### 使用Fama-MacBeth截面回归分析的含义解读

1. 

### Fama-MacBeth截面回归总结

然而与前面的方法相比，Fama-MacBeth截面回归分析需要假设变量对于未来收益率的影响是线性的，也就是它只能检验两者是否存在线性关系，这也是该方法的一个局限性。除了上述手动实现的方法之外，还可以调用python的Linermodels库，直接获得Fama-MacBeth的估计结果。

```python
linearmodels.panel.model.FamaMacBeth(y,X).fit(cov_type='kernel',bandwidth=4)
```

y：被解释变量

X：解释变量和控制变量，如果数据中没有常数项，需要手动添加。

cov_type：使用参数'kernel'来获得Newey-West调整后的标准误统计量。

bandwidth:指定Newey-West调整滞后的期数，可以根据Newey和West提供的公式L=[4x(T/100)^(2/9)]计算得到。